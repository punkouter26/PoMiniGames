const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ragdolls-USQMMoJR.js","assets/index-e522FiC1.js","assets/index-CE7QXiT_.css"])))=>i.map(i=>d[i]);
import{V as l,B as me,M as ue,a as q,b as ge,D as xe,P as he,C as Ie,c as re,r,d as ze,u as Be,S as be,e as Te,F as Le,f as De,W as ke,g as Ge,A as ve,H as Ze,h as Ae,_ as Me,R as Pe,j as Fe}from"./index-e522FiC1.js";import{b as G,c as Oe,s as Ne}from"./ragdolls-USQMMoJR.js";const we={x:0,y:-9.81,z:0};function Ve(f,a,X,z=-5){const t=re.degToRad(X),T=200,n=20,v=[],L=[],Z=[],C={x:n,y:1,z:T},ee=Math.sin(t)*(T/2),F=Math.cos(t)*(T/2),fe=C.y/2*Math.cos(t),P=new l(0,z+ee-fe,F),J=new l(0,0,-T/2),O=new l(0,0,T/2),N=P.clone().add(J.applyAxisAngle(new l(1,0,0),t)),Q=P.clone().add(O.applyAxisAngle(new l(1,0,0),t)),ae=G.RigidBodyDesc.fixed().setTranslation(P.x,P.y,P.z).setRotation({x:Math.sin(t/2),y:0,z:0,w:Math.cos(t/2)}),te=a.createRigidBody(ae),$=G.ColliderDesc.cuboid(C.x/2,C.y/2,C.z/2);$.setFriction(0),$.setRestitution(.1),a.createCollider($,te),v.push(te);const ne=new me(C.x,C.y,C.z),ce=new ue({color:5921390,roughness:.6,metalness:.1}),V=new q(ne,ce);V.position.copy(P),V.rotation.x=t,V.receiveShadow=!0,f.add(V),L.push(V);const ie=new ge({color:16777215,transparent:!0,opacity:.3,side:xe}),oe=n/8;for(let i=1;i<8;i++){const y=new he(.1,T-10),R=new q(y,ie),S=-n/2+i*oe,p=new l(S,.55,0);p.applyAxisAngle(new l(1,0,0),t),R.position.copy(P.clone().add(p)),R.rotation.x=-Math.PI/2+t,f.add(R),L.push(R)}const A=z-5,_=G.RigidBodyDesc.fixed().setTranslation(0,A,0),c=a.createRigidBody(_);a.createCollider(G.ColliderDesc.cuboid(250,.5,250),c),v.push(c);const m=10,g=new ue({color:4251856,opacity:.5,transparent:!0}),I=i=>{const y={x:.5,y:m,z:T},R=new l(i,m/2,0);R.applyAxisAngle(new l(1,0,0),t);const S=P.clone().add(R),p=G.RigidBodyDesc.fixed().setTranslation(S.x,S.y,S.z).setRotation({x:Math.sin(t/2),y:0,z:0,w:Math.cos(t/2)}),x=a.createRigidBody(p),u=G.ColliderDesc.cuboid(y.x/2,y.y/2,y.z/2);u.setFriction(0),a.createCollider(u,x),v.push(x);const h=new me(y.x,y.y,y.z),o=new q(h,g);o.position.copy(S),o.rotation.x=t,f.add(o),L.push(o)};I(-n/2-.25),I(n/2+.25);const W=Q.z,j=new l(0,z+4,W),w=new ge({color:16711680,side:xe}),D=new he(n+4,8),H=new q(D,w);H.position.copy(j),f.add(H),L.push(H);const K=new he(n,2),B=new q(K,w);B.position.set(0,z+.02,W),B.rotation.x=-Math.PI/2,f.add(B),L.push(B);const U=new ue({color:16729156,metalness:.6,roughness:.3}),Y=10,b=140/Y;for(let i=0;i<Y;i++){const R=-60+i*b+Math.random()*(b*.7),p=(Math.random()>.5?1:-1)*(2+Math.random()*(n/2-4)),x=Math.random()>.5;let u,h,o;x?(o=3,u=G.ColliderDesc.cylinder(o/2,.7),h=new q(new Ie(.7,.7,o,12),U)):(o=1.5,u=G.ColliderDesc.cuboid(.5,o/2,.5),h=new q(new me(1,o,1),U));const E=new l(p,.5+o/2,R);E.applyAxisAngle(new l(1,0,0),t);const e=P.clone().add(E),d=G.RigidBodyDesc.fixed().setTranslation(e.x,e.y,e.z).setRotation({x:Math.sin(t/2),y:0,z:0,w:Math.cos(t/2)}),s=a.createRigidBody(d);a.createCollider(u,s),v.push(s),h.position.copy(e),h.rotation.x=t,h.castShadow=!0,f.add(h),L.push(h)}return{ramp:V,bodies:v,meshes:L,animatedObjects:Z,finishZ:W,rampPos:P,rampTopZ:N.z,rampBottomZ:Q.z,groundY:z,angleRad:t,world:a}}function We(f,a){f.forEach(X=>X.update(a))}const Se=-5,ye=6,je=6.5;function Ye(){const f=r.useRef(null),a=r.useRef(null),X=r.useRef(null),z=r.useRef(null),t=r.useRef(null),T=r.useRef(new ze),n=r.useRef([]),v=r.useRef(null),L=r.useRef(0),Z=r.useRef(!1),C=r.useRef(!1),ee=r.useRef(!1),F=r.useRef(0),fe=r.useRef(0),P=r.useRef([]),J=r.useRef(0),O=r.useRef(new l),N=r.useRef(new l),{racers:Q,finishRace:ae,state:te}=Be(),$=r.useRef(te);$.current=te;const ne=r.useRef(ae);ne.current=ae;const[ce,V]=r.useState(!1);r.useEffect(()=>{let A=!0;async function _(){try{await(await Me(()=>import("./ragdolls-USQMMoJR.js").then(m=>m.r),__vite__mapDeps([0,1,2]))).init(),A&&(V(!0),console.log("Rapier Physics Initialized"))}catch(c){console.error("Failed to init Rapier:",c)}}return _(),()=>{A=!1}},[]);const ie=r.useCallback(async()=>{if(!f.current||!ce)return;a.current&&f.current.contains(a.current.domElement)&&(f.current.removeChild(a.current.domElement),a.current.dispose()),z.current&&(z.current.free(),z.current=null);const A=f.current,_=A.clientWidth,c=A.clientHeight,m=new be;m.background=new Te(1981023),m.fog=new Le(1981023,80,400),X.current=m;const g=new De(60,_/c,.1,1e3);g.position.set(0,15,-30),t.current=g;const I=new ke({antialias:!0});I.setSize(_,c),I.setPixelRatio(Math.min(window.devicePixelRatio,2)),I.shadowMap.enabled=!0,I.shadowMap.type=Ge,A.appendChild(I.domElement),a.current=I;const W=new ve(16777215,.6);m.add(W);const j=new Ze(8900331,4473924,.8);m.add(j);const w=new Ae(16777215,2.5);w.position.set(30,80,-20),w.castShadow=!0,w.shadow.mapSize.width=2048,w.shadow.mapSize.height=2048,w.shadow.camera.near=.5,w.shadow.camera.far=500,w.shadow.camera.left=-100,w.shadow.camera.right=100,w.shadow.camera.top=100,w.shadow.camera.bottom=-100,m.add(w);const D=new Ae(16769202,1);D.position.set(-40,50,60),m.add(D);const H=new he(500,500),K=new ue({color:2763322,roughness:.9}),B=new q(H,K);B.rotation.x=-Math.PI/2,B.position.y=Se,B.receiveShadow=!0,m.add(B);const U=await Me(()=>import("./ragdolls-USQMMoJR.js").then(p=>p.r),__vite__mapDeps([0,1,2])),Y=new U.World(new U.Vector3(we.x,we.y,we.z));z.current=Y;const b=20,i=Ve(m,Y,b,Se);v.current=i;const y=re.degToRad(b),R=20,S=R/8;if(n.current=Q.map((p,x)=>{const u=-R/2+S/2+x*S,h=-80,o=new l(u,3,h);o.applyAxisAngle(new l(1,0,0),y);const E=i.rampPos.clone().add(o),e=Pe.find(s=>s.type===p.type)||Pe[0],d=Oe(m,Y,E,e.type);return{bodies:d.bodies,parts:d.parts,headBody:d.headBody}}),P.current=Q.map(()=>.7+Math.random()*.6),typeof window<"u"){const p=n.current.map((x,u)=>{const h=x.headBody.translation();return{index:u,x:h.x,y:h.y,z:h.z}});window.__RACE_INITIAL_POSITIONS__=p,window.__TRACK_INFO__={finishZ:i.finishZ,rampPosY:i.rampPos.y,rampPosZ:i.rampPos.z,rampTopZ:i.rampTopZ,rampBottomZ:i.rampBottomZ,groundY:i.groundY,angleRad:i.angleRad,startZ:-80},window.__RACE_CAMERA_DEBUG__=null,window.__RACE_CAMERA_SAMPLES__=[],window.__RACE_TIMING__={targetSeconds:ye,startedAt:performance.now(),finishedAt:null,elapsedSeconds:null}}if(Y.step(),n.current.length>0){let p=1/0,x=-1/0,u=0;n.current.forEach(E=>{const e=E.headBody.translation();e.z<p&&(p=e.z),e.z>x&&(x=e.z),u+=e.y}),u/=n.current.length,g.position.set(0,u+15,p-25),g.lookAt(0,u,x);const h=n.current.reduce((E,e,d,s)=>e.headBody.translation().z>s[E].headBody.translation().z?d:E,0),o=n.current[h].headBody.translation();O.current.set(o.x,o.y,o.z),N.current.set(o.x,o.y+1.2,o.z+8),J.current=h}Z.current=!1,C.current=!1,ee.current=!1,F.current=performance.now(),fe.current=0,T.current=new ze},[Q,ce]),oe=r.useCallback(()=>{var o,E;L.current=requestAnimationFrame(oe);const A=z.current,_=X.current,c=t.current,m=a.current,g=v.current;if(!A||!_||!c||!m||!g)return;const I=Math.min(T.current.getDelta(),.1),W=!C.current;if(W&&(C.current=!0),!W&&!Z.current){const e=g.angleRad,d=Math.sin(e),s=Math.cos(e),M=5,de=8;n.current.forEach((le,Ee)=>{const Ce=P.current[Ee]??1,se=le.bodies[0];if(!se)return;const Re=M*Ce*se.mass();se.addForce({x:0,y:-d*Re,z:s*Re},!0);const k=se.linvel(),_e=Math.sqrt(k.x*k.x+k.y*k.y+k.z*k.z);if(_e>de){const pe=de/_e;se.setLinvel({x:k.x*pe,y:k.y*pe,z:k.z*pe},!0)}}),A.step()}Ne(n.current),g.animatedObjects&&We(g.animatedObjects,I);let j=-1/0,w=0;const D=new l,H=[];let K=1/0;n.current.forEach((e,d)=>{const s=e.headBody.translation(),M=new l(s.x,s.y,s.z);H.push(M),s.z>j&&(j=s.z,w=d,D.copy(M)),s.z<K&&(K=s.z)});const B=Math.min(J.current,Math.max(0,n.current.length-1)),U=(o=n.current[B])==null?void 0:o.headBody.translation();(!U||j-U.z>1.5)&&(J.current=w);const b=n.current[Math.min(J.current,n.current.length-1)];if(b){const e=b.headBody.translation();D.set(e.x,e.y,e.z)}const i=new l(0,-Math.sin(g.angleRad),Math.cos(g.angleRad)).normalize(),y=(E=b==null?void 0:b.bodies[0])==null?void 0:E.linvel(),R=y?Math.sqrt(y.x**2+y.y**2+y.z**2):0,S=re.clamp(8+R*.2,8,12),p=re.clamp(4+R*.08,4,6),x=re.clamp(10+R*.35,10,18),u=D.clone().addScaledVector(i,-S).add(new l(0,p,0));u.y=Math.max(u.y,g.groundY+3.5),O.current.lerp(D,.08);const h=O.current.clone().addScaledVector(i,x).add(new l(0,1.2,0));if(N.current.lerp(h,.1),ee.current?c.position.lerp(u,.06):(c.position.copy(u),ee.current=!0),c.lookAt(N.current),typeof window<"u"){const e={leaderIndex:w,leader:{x:O.current.x,y:O.current.y,z:O.current.z},camera:{x:c.position.x,y:c.position.y,z:c.position.z},lookTarget:{x:N.current.x,y:N.current.y,z:N.current.z},followDistance:S,followHeight:p,lookAhead:x,leadZ:j,packMinZ:K,timestamp:performance.now()},d=window;d.__RACE_CAMERA_DEBUG__=e;const s=d.__RACE_CAMERA_SAMPLES__??[];s.push(e),s.length>300&&s.shift(),d.__RACE_CAMERA_SAMPLES__=s,d.__RACE_PACK_POSITIONS__=H.map(M=>({x:M.x,y:M.y,z:M.z}))}if(!Z.current&&$.current==="RACING"&&(n.current.forEach((e,d)=>{if(e.headBody.translation().z>=g.finishZ){if(Z.current=!0,typeof window<"u"){const M=(performance.now()-F.current)/1e3;window.__RACE_TIMING__={targetSeconds:ye,startedAt:F.current,finishedAt:performance.now(),elapsedSeconds:M}}ne.current(d)}}),!Z.current&&(performance.now()-F.current)/1e3>je)){let d=0,s=-1/0;if(n.current.forEach((M,de)=>{const le=M.headBody.translation().z;le>s&&(s=le,d=de)}),Z.current=!0,typeof window<"u"){const M=(performance.now()-F.current)/1e3;window.__RACE_TIMING__={targetSeconds:ye,startedAt:F.current,finishedAt:performance.now(),elapsedSeconds:M}}ne.current(d)}m.render(_,c)},[]);return r.useEffect(()=>{ie(),oe();const A=()=>{if(!f.current||!t.current||!a.current)return;const _=f.current.clientWidth,c=f.current.clientHeight;t.current.aspect=_/c,t.current.updateProjectionMatrix(),a.current.setSize(_,c)};return window.addEventListener("resize",A),()=>{var _,c;cancelAnimationFrame(L.current),window.removeEventListener("resize",A),a.current&&((_=f.current)!=null&&_.contains(a.current.domElement))&&f.current.removeChild(a.current.domElement),(c=a.current)==null||c.dispose(),z.current&&(z.current.free(),z.current=null)}},[ie,oe]),Fe.jsx("div",{ref:f,"data-testid":"race-canvas",className:"w-full h-full"})}export{Ye as default};
